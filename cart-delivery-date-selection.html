<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<div class="delivery-date-selection">
    <div class="form-wrapper">
        <form class="delivery-date-selection">
            <input type="text" name="query" placeholder="Suburb or postcode" required autofocus/>
            <input type="submit" value="Search"/>
        </form>
    </div>

    <div class="delivery-zone-wrapper">
        <div class="results"></div>
    </div>
    <input required class="required" id="delivery-date" type="text" name="attributes[Delivery date]" style="display: none; display: initial">
    <div class="delivery-datepicker"></div>
</div>
<script id="zone-noresult-template" type="text/template">
    <div style="margin: 1em;">
    <h4>Sorry, we don't deliver to "{ query }".</h4>
    </div>
</script>
<script>
(function () {
    function storeZone(zone) {
        store(zone, zone.postcode);
        store(zone, zone.suburb);
        var sub = convertQuery(zone.suburb);
        for (var i = 4; i < sub.length; i++) {
            store(zone, sub.substring(0, i));
        }
    }
    function store(zone, query) {
        if (!query) {
            console.log(zone);
            return;
        }
        var key = convertQuery(query);
        if (lookup.hasOwnProperty(key)) {
            lookup[key].push(zone);
        } else {
            lookup[key] = [zone];
        }
    }
    function search(query) {
        var key = convertQuery(query);
        return lookup[key] || [];
    }
    function convertQuery(query) {
        return query.replace(/ /g, '').toLowerCase();
    }
    function render(query, results) {
        var resultsElem = document.querySelector('.results');
        resultsElem.innerHTML = '';
        if (results.length === 0) {
            var template = document.getElementById('zone-noresult-template').textContent;
            resultsElem.innerHTML = template.replace('{ query }', query);
        }
        if (results.length === 1) {
            var delivery = nextDelivery(results[0]);
            selectDestination(delivery);
        }
        var datalist = [];
        if (results.length > 1) {
            for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var name = result.suburb + ' ' + result.postcode;
                datalist.push(name);
            }
        }
        $(queryElem).autocomplete('option', 'source', datalist);
    }
    function selectDestination(delivery) {
        var deliveryDates = delivery.deliveryDates || [delivery.deliveryDate];
        var dateMap = {};
        for (var i = 0; i < deliveryDates.length; i++) {
            dateMap[deliveryDates[i].toDateString()] = true;
        }
        $('.delivery-datepicker').datepicker('option', 'minDate', delivery.deliveryDate);
        $('.delivery-datepicker').datepicker('option', 'beforeShowDay', function (date) {
            if (dateMap[date.toDateString()]) {
                return [true, '', ''];
            }
            return [false, '', ''];
        });
        $('.delivery-datepicker').show();
    }
    function createFromTemplate(template, result) {
        var parent = document.createElement('div');
        parent.innerHTML = renderTemplate(template, result);
        return parent.children[0];
    }
    function renderTemplate(template, data) {
        return template.replace(/{ ([a-z]+) }/g, function (match, key) {
            if (typeof data[key] === 'undefined') {
                console.log(match);
                return match;
            } else {
                return data[key];
            }
        });
    }
    function nextDelivery(zone) {
        var freq = zone.frequency;
        var today = new Date();
        if (freq === 'Daily (business days)') {
            return nextDailyDeliveries(today);
        }
        if (freq === 'Weekly') {
            return nextWeeklyDelivery(today, zone);
        }
        if (freq === 'Fortnightly') {
            return nextFortnightlyDelivery(today, zone);
        }
        console.log("Error: unknown frequency: " + freq);
        return {
            cutoffTime: '',
            cutoffDate: '',
            deliveryDate: ''
        };
    }
    function nextDailyDeliveries(start) {
        // After midday, start search the following day
        if (start.getHours() > 11) {
            start = addDays(start, 1);
        }
        var cutoffDate = nextBusinessDate(start);
        var deliveryDate = addDays(cutoffDate, 1);
        return {
            cutoffTime: 'midday',
            cutoffDate: cutoffDate,
            deliveryDate: deliveryDate,
            deliveryDates: nextDates(deliveryDate, 12, [1, 2, 3, 4, 5, 6])
        };
    }
    function nextWeeklyDelivery(start, zone) {
        var cutoffDaysPrior = +zone.turn + 1;
        var deliveryDays = parseDays(zone.day);
        var deliveryStart = addBusinessDays(start, cutoffDaysPrior);
        var deliveryDate = advanceToDay(deliveryStart, deliveryDays);
        var cutoffDate = addBusinessDays(deliveryDate, -cutoffDaysPrior);
        return {
            cutoffTime: 'midnight',
            cutoffDate: cutoffDate,
            deliveryDate: deliveryDate,
            deliveryDates: nextDates(deliveryDate, 6, deliveryDays)
        };

    }
    function nextFortnightlyDelivery(start, zone) {
        var cutoffDaysPrior = +zone.turn + 1;
        var deliveryDays = parseDays(zone.day);
        var deliveryStart = addBusinessDays(start, cutoffDaysPrior);
        var deliveryDate = advanceToDayInFortnight(deliveryStart, deliveryDays, zone.deliveryDate);
        var cutoffDate = addBusinessDays(deliveryDate, -cutoffDaysPrior);
        var deliveryDates = [
            deliveryDate,
            addDays(deliveryDate, 14),
            addDays(deliveryDate, 28)
        ];
        return {
            cutoffTime: 'midnight',
            cutoffDate: cutoffDate,
            deliveryDate: deliveryDate,
            deliveryDates: deliveryDates
        };

    }
    function nextBusinessDate(start) {
        var startDay = start.getDay();
        var daysToAdvance = daysToNextBusinessDay(startDay);
        return addDays(start, daysToAdvance);
    }
    function daysToNextBusinessDay(day) {
        if (day < 1) {
            return 1;
        }
        if (day > 5) {
            return 2;
        }
        return 0;
    }
    function parseDays(string) {
        var names;
        if (string.indexOf('/ ') !== -1) {
            names = string.split('/ ');
        } else if (string.indexOf(', ') !== -1) {
            names = string.split(', ');
        } else {
            names = [string];
        }
        return names.map(parseDay);
    }
    function parseDay(dayName) {
        return dayNums[dayName.substr(0, 3)];
    }
    function addDays(date, days) {
        var newDate = new Date(date);
        newDate.setDate(date.getDate() + days);
        return newDate;
    }
    function addBusinessDays(date, businessDays) {
        date = nextBusinessDate(date);
        var weeks;
        if (businessDays < 0) {
            weeks = Math.ceil(businessDays / 5);
        } else {
            weeks = Math.floor(businessDays / 5);
        }
        var remainingDays = businessDays % 5;
        var weekendDays = 0;
        var day = date.getDay();
        // If we cross a weekend
        if (day + remainingDays > 5) {
            weekendDays += 2;
        }
        if (day + remainingDays < 1) {
            weekendDays -= 2;
        }
        var totalDays = weeks * 7 + weekendDays + remainingDays;
        return addDays(date, totalDays);
    }
    function nextDates(startDate, number, deliveryDays) {
        var startDay = startDate.getDay();
        var daysFromStart = deliveryDays.map(function (dayOfWeek) {
            var days = dayOfWeek - startDay;
            if (dayOfWeek < startDay) {
                days += 7;
            }
            return days;
        }).sort();
        var dates = [];
        for (var i = 0; i < number; i++) {
            var cycles = Math.floor(i / daysFromStart.length);
            var index = i % daysFromStart.length;
            var days = cycles * 7 + daysFromStart[index];
            dates.push(addDays(startDate, days));
        }
        return dates;
    }
    function advanceToDay(startDate, deliveryDays) {
        var startDay = startDate.getDay();
        var soonestDate;
        var minimumDays = 14;
        for (var i = 0; i < deliveryDays.length; i++) {
            var dayOfWeek = deliveryDays[i];
            if (dayOfWeek === startDay) {
                return startDate;
            }
            var days = dayOfWeek - startDay;
            if (dayOfWeek < startDay) {
                days += 7;
            }
            if (days < minimumDays) {
                soonestDate = addDays(startDate, days);
                minimumDays = days;
            }
        }
        return soonestDate;
    }
    function advanceToDayInFortnight(startDate, deliveryDays, referenceDateString) {
        var nextDate = advanceToDay(startDate, deliveryDays);
        var dayMonthYear = referenceDateString.split('/').map(Number);
        var refMonth = dayMonthYear[1] - 1;
        var refDate = new Date(dayMonthYear[2], refMonth, dayMonthYear[0]);
        if (isInFortnightlyInterval(nextDate, refDate)) {
            return nextDate;
        }
        return addDays(nextDate, 7);
    }
    function daysBetween(date1, date2) {
        var a = new Date(date1.getFullYear(), date1.getMonth(), date1.getDate());
        var b = new Date(date2.getFullYear(), date2.getMonth(), date2.getDate());
        var diff = b - a;
        return diff / 1000 / 60 / 60 / 24;
    }
    function isInFortnightlyInterval(date, referenceDate) {
        var days = daysBetween(date, referenceDate);
        return (days % 14) === 0;
    }
    function searchAndDisplay() {
        var query = queryElem.value;
        if (query && query.length > 3) {
            var results = search(query);
            render(query, results);
        }
        return false;

    }
    function fillLookupTable(zones) {
        for (var i = 0; i < zones.length; i++) {
            storeZone(zones[i]);
        }
    }
    function getJson(url, callback) {
        var req = new XMLHttpRequest();
        req.open('GET', url);
        req.onreadystatechange = function () {
            if (req.readyState === XMLHttpRequest.DONE) {
                if (req.status === 200) {
                    var data = JSON.parse(req.responseText);
                    callback(data);
                } else {
                    console.log(req);
                }
            }
        };
        req.send();
    }
    var dayNums = {
        "Sun": 0,
        "Mon": 1,
        "Tue": 2,
        "Wed": 3,
        "Thu": 4,
        "Fri": 5,
        "Sat": 6
    };
    var dayNames = [
        "Sunday",
        "Monday",
        "Tuesday",
        "Wednesday",
        "Thursday",
        "Friday",
        "Saturday"
    ];
    var lookup = {};
    getJson('https://cdn.shopify.com/s/files/1/1869/3543/files/schedule.json?13697742335530475366', fillLookupTable);
    var form = document.querySelector('form.delivery-date-selection');
    var queryElem = form.querySelector('input[name="query"]');
    form.onsubmit = searchAndDisplay;
    queryElem.oninput = searchAndDisplay;
    $(function () {
        var defaultDate = $('input[name="attributes[Delivery date]"]').val();
        $('.delivery-datepicker').datepicker({
            altField: 'input[name="attributes[Delivery date]"]',
            dateFormat: 'D, d M y',
            defaultDate: defaultDate,
            beforeShowDay: function () {
                return [false, '', 'Please select a destination first.'];
            }
        });
        $('.delivery-datepicker').hide();
        $('input[name="attributes[Delivery date]"]').val(defaultDate);
    });
    $(queryElem).autocomplete({source: []});
    // testing
    function assertEquals(result, expected) {
        if (result !== expected) {
            console.log("Fail: two objects are not the same.");
            console.log(expected);
            console.log(result);
        }
    }

    var result;

    result = parseDays('Friday');
    assertEquals(result[0], 5);
    result = parseDays('Tues/ Thurs');
    assertEquals(result[0], 2);
    assertEquals(result[1], 4);
    result = parseDays('Mon, Wed, Thurs');
    assertEquals(result[0], 1);
    assertEquals(result[1], 3);
    assertEquals(result[2], 4);
    result = parseDays('Thur');
    assertEquals(result[0], 4);
    result = parseDays('Tuesday');
    assertEquals(result[0], 2);
    result = parseDays('Saturday');
    assertEquals(result[0], 6);

    var mondayMorning = new Date('Mon, 12 Jun 2017 10:00:00');
    var mondayAfternoon = new Date('Mon, 12 Jun 2017 14:00:00');
    var fridayMorning = new Date('Fri, 16 Jun 2017 10:00:00');
    var saturdayMorning = new Date('Sat, 17 Jun 2017 10:00:00');
    var castlemaine = {turn: "3", day: "Wednesday"};
    var bundanoon = {turn: "5", deliveryDate: "28/06/2017", day: "Wednesday"};
    var mannum = {turn: "6", deliveryDate: "01/07/2017", day: "Saturday"};

    result = addBusinessDays(mondayMorning, 0);
    assertEquals(result.toDateString(), 'Mon Jun 12 2017');
    result = addBusinessDays(mondayMorning, 1);
    assertEquals(result.toDateString(), 'Tue Jun 13 2017');
    result = addBusinessDays(mondayMorning, 4);
    assertEquals(result.toDateString(), 'Fri Jun 16 2017');
    result = addBusinessDays(mondayMorning, 5);
    assertEquals(result.toDateString(), 'Mon Jun 19 2017');
    result = addBusinessDays(mondayMorning, 11);
    assertEquals(result.toDateString(), 'Tue Jun 27 2017');

    result = addBusinessDays(mondayMorning, -1);
    assertEquals(result.toDateString(), 'Fri Jun 09 2017');
    result = addBusinessDays(mondayMorning, -6);
    assertEquals(result.toDateString(), 'Fri Jun 02 2017');
    result = addBusinessDays(saturdayMorning, -1);
    assertEquals(result.toDateString(), 'Fri Jun 16 2017');
    result = addBusinessDays(saturdayMorning, -7);
    assertEquals(result.toDateString(), 'Thu Jun 08 2017');

    result = advanceToDay(mondayMorning, [1]);
    assertEquals(result.toDateString(), 'Mon Jun 12 2017');
    result = advanceToDay(mondayMorning, [2]);
    assertEquals(result.toDateString(), 'Tue Jun 13 2017');
    result = advanceToDay(fridayMorning, [2]);
    assertEquals(result.toDateString(), 'Tue Jun 20 2017');
    result = advanceToDay(fridayMorning, [2, 6, 4]);
    assertEquals(result.toDateString(), 'Sat Jun 17 2017');

    result = nextDates(mondayMorning, 12, [1, 3, 6]);
    assertEquals(result.length, 12);
    assertEquals(result[0].toDateString(), 'Mon Jun 12 2017');
    assertEquals(result[1].toDateString(), 'Wed Jun 14 2017');
    assertEquals(result[2].toDateString(), 'Sat Jun 17 2017');
    assertEquals(result[3].toDateString(), 'Mon Jun 19 2017');

    result = nextDates(fridayMorning, 2, [1, 3, 6]);
    assertEquals(result.length, 2);
    assertEquals(result[0].toDateString(), 'Sat Jun 17 2017');
    assertEquals(result[1].toDateString(), 'Mon Jun 19 2017');

    result = nextDailyDeliveries(mondayMorning);
    assertEquals(result.deliveryDate.toDateString(), 'Tue Jun 13 2017');
    result = nextDailyDeliveries(mondayAfternoon);
    assertEquals(result.deliveryDate.toDateString(), 'Wed Jun 14 2017');
    result = nextDailyDeliveries(fridayMorning);
    assertEquals(result.deliveryDate.toDateString(), 'Sat Jun 17 2017');
    result = nextDailyDeliveries(saturdayMorning);
    assertEquals(result.deliveryDate.toDateString(), 'Tue Jun 20 2017');

    result = nextWeeklyDelivery(mondayMorning, castlemaine);
    assertEquals(result.cutoffDate.toDateString(), 'Thu Jun 15 2017');
    assertEquals(result.deliveryDate.toDateString(), 'Wed Jun 21 2017');

    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, 14));
    assertEquals(result, true);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, -14));
    assertEquals(result, true);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, -28));
    assertEquals(result, true);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, 28));
    assertEquals(result, true);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, 7));
    assertEquals(result, false);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, -7));
    assertEquals(result, false);
    result = isInFortnightlyInterval(mondayMorning, addDays(mondayMorning, 21));
    assertEquals(result, false);

    result = nextFortnightlyDelivery(mondayMorning, bundanoon);
    assertEquals(result.cutoffDate.toDateString(), 'Tue Jun 20 2017');
    assertEquals(result.deliveryDate.toDateString(), 'Wed Jun 28 2017');

    result = nextFortnightlyDelivery(mondayMorning, mannum);
    assertEquals(result.cutoffDate.toDateString(), 'Thu Jun 22 2017');
    assertEquals(result.deliveryDate.toDateString(), 'Sat Jul 01 2017');
}());
</script>
